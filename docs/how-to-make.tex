\newcommand{\NWtarget}[2]{\hypertarget{#1}{#2}}
\newcommand{\NWlink}[2]{\hyperlink{#1}{#2}}
\newcommand{\NWtxtMacroDefBy}{Fragment defined by}
\newcommand{\NWtxtMacroRefIn}{Fragment referenced in}
\newcommand{\NWtxtMacroNoRef}{Fragment never referenced}
\newcommand{\NWtxtDefBy}{Defined by}
\newcommand{\NWtxtRefIn}{Referenced in}
\newcommand{\NWtxtNoRef}{Not referenced}
\newcommand{\NWtxtFileDefBy}{File defined by}
\newcommand{\NWtxtIdentDefinedIn}{defined in}
\newcommand{\NWtxtIdentUsedIn}{used in}
\newcommand{\NWtxtIdentUsers}{Users:}
\newcommand{\NWtxtIdentsNotUsed}{never used}
\newcommand{\NWtxtIdentsUsed}{Uses:}
\newcommand{\NWsep}{${\diamond}$}
\newcommand{\NWnotglobal}{(not defined globally)}
\newcommand{\NWuseHyperlinks}{}
\documentclass[a4paper, 12pt]{article}
\usepackage{fullpage} % for 1.5 cm margins
\renewcommand{\familydefault}{\sfdefault} % so it doesn't look like LaTeX
\usepackage{helvet}
\usepackage{graphicx}
\graphicspath{ {imgs/} }
\usepackage{float} % so the figures stay with the text

\usepackage{abstract}
\renewcommand{\abstractname}{Overview}
\raggedright

\usepackage{parskip}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}

\usepackage{listings}
\usepackage{color}
\lstset{ 
  language=c++, % the language of the code
  keywordstyle=\color{red} % keyword style
}

\title{Promethean Temperature Sensor}
\author{Joe Collins}

\begin{document}
\maketitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Problem}

A temperature sensor that can be monitoring using Prometheus (\url{https://prometheus.io/}).

Prometheus is our main system for monitoring system status,
so it makes sense to have temperature sensors that can also be monitored using Prometheus.
There doesn't appear to be anything available off the shelf.
There are temperature monitors but some effort would be required to get 
them to integrate with our Prometheus monitoring system.
So we might as well build a bespoke temperature sensor
that can be polled directly by Prometheus.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Components}

Shopping list and details, with prices.

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{components.jpg}
  \caption{Components}
\end{figure}


\begin{tabular}{ll}
  \textbf{Component} & \textbf{Cost} \\ 
  \hline
  Arduino Uno Rev3, ATmega328P, CH340G Compatible Board & \pounds 5.79 \\
  UK 9V AC/DC Power Supply Adapter Plug for Arduino Uno & \pounds 7.95 \\
  Ethernet Shield LAN W5100 for Arduino Uno & \pounds 7.75 \\
  DHT22 AM2302 Digital Temperature and Humidity Sensor & \pounds 6.90 \\
  0.25 Watt Metal Film Resistor 10K Ohm & \pounds 0.99 \\
  Uno Ethernet Shield Case & \pounds 10.36 \\
  \hline
  Total cost in November 2020 & \textbf{\pounds 39.74}  \\
\end{tabular}

\subsection{Sensor}

AM2302 capacitive humidity sensing digital temperature and humidity module is one that contains the
compound has been calibrated digital signal output of the temperature and humidity sensors. 



\subsection{Sensor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Wiring}

Pull up resistor.



\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{wiring-dht22.jpg}
  \caption{Wiring diagram with pull up resistor}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Programming}

Install 

\begin{itemize}
  \item VSCode \\
  \url{https://code.visualstudio.com/}
  \item Platformio \\
  \url{https://marketplace.visualstudio.com/items?itemName=platformio.platformio-ide}
\end{itemize}



Platform io

Include serial for output to monitor

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap1}\raggedright\small
\NWtarget{nuweb4a}{}\verb@"../src/shit.cpp"@\nobreak\ {\footnotesize{4a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@#include <Arduino.h>@\\
\mbox{}\lstinline@@$\langle\,${\itshape libraries}\ {\footnotesize \NWlink{nuweb4b}{4b}},\ ...\,$\rangle\,$\verb@@\\
\mbox{}\lstinline@@$\langle\,${\itshape configuration}\ {\footnotesize \NWlink{nuweb5a}{5a}},\ ...\,$\rangle\,$\verb@@\\
\mbox{}\lstinline@@$\langle\,${\itshape functions}\ {\footnotesize \NWlink{nuweb5c}{5c}},\ ...\,$\rangle\,$\verb@@\\
\mbox{}\lstinline@@\\
\mbox{}\lstinline@void setup() @\\
\mbox{}\lstinline@{@\\
\mbox{}\lstinline@  // Open serial communications and wait for the port to open.@\\
\mbox{}\lstinline@  Serial.begin(9600);@\\
\mbox{}\lstinline@  while (!Serial) @\\
\mbox{}\lstinline@  {@\\
\mbox{}\lstinline@    ; // Wait for serial port to connect (only needed for native USB ports).@\\
\mbox{}\lstinline@  }@\\
\mbox{}\lstinline@  @$\langle\,${\itshape setup}\ {\footnotesize \NWlink{nuweb5b}{5b}}\,$\rangle\,$\verb@@\\
\mbox{}\lstinline@}@\\
\mbox{}\lstinline@@\\
\mbox{}\lstinline@void loop() @\\
\mbox{}\lstinline@{@\\
\mbox{}\lstinline@  @$\langle\,${\itshape loop}\ {\footnotesize \NWlink{nuweb7a}{7a}}\,$\rangle\,$\verb@@\\
\mbox{}\lstinline@}@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\end{minipage}
\end{flushleft}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sensor}

Why Adafruit library?

Why DHT library?

Serial Peripheral Interface (SPI) is a synchronous serial data protocol
used by microcontrollers for communicating with peripheral devices quickly over short distances.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap2}\raggedright\small
\NWtarget{nuweb4b}{}$\langle\,${\itshape libraries}\nobreak\ {\footnotesize{4b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@// Sensor libraries:@\\
\mbox{}\lstinline@#include <Adafruit_Sensor.h>@\\
\mbox{}\lstinline@#include <DHT.h>@\\
\mbox{}\lstinline@#include <SPI.h>@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb4b}{4b}, \NWlink{nuweb6b}{6b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

Pin and DHT type
DHT11 cheaper and less precise probably would be just as good for our situation
DHT21 (AM2301)

Register the pin used see wiring.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap3}\raggedright\small
\NWtarget{nuweb5a}{}$\langle\,${\itshape configuration}\nobreak\ {\footnotesize{5a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@// Sensor config@\\
\mbox{}\lstinline@#define DHTPIN 2@\\
\mbox{}\lstinline@#define DHTTYPE DHT22   // DHT 22  (AM2302)@\\
\mbox{}\lstinline@DHT dht = DHT(DHTPIN, DHTTYPE); // Initialize DHT sensor for normal 16mhz Arduino:@\\
\mbox{}\lstinline@// globals to store readings@\\
\mbox{}\lstinline@float temperature = 0;@\\
\mbox{}\lstinline@float humidity = 0;@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb5a}{5a}, \NWlink{nuweb6c}{6c}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

The sensor needs to begin, why?

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap4}\raggedright\small
\NWtarget{nuweb5b}{}$\langle\,${\itshape setup}\nobreak\ {\footnotesize{5b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@  Serial.println("Set up sensor");@\\
\mbox{}\lstinline@  dht.begin();@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

Set the values in the globals,
could have passed stuff around.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap5}\raggedright\small
\NWtarget{nuweb5c}{}$\langle\,${\itshape functions}\nobreak\ {\footnotesize{5c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@void readSensor()@\\
\mbox{}\lstinline@{@\\
\mbox{}\lstinline@  // Read the humidity in %:@\\
\mbox{}\lstinline@  humidity = dht.readHumidity();@\\
\mbox{}\lstinline@  // Read the temperature as Celsius:@\\
\mbox{}\lstinline@  temperature = dht.readTemperature();@\\
\mbox{}\lstinline@  // Check if any reads failed and exit early (to try again):@\\
\mbox{}\lstinline@  if (isnan(humidity) || isnan(temperature)) @\\
\mbox{}\lstinline@  {@\\
\mbox{}\lstinline@    Serial.println("Failed to read from sensor");@\\
\mbox{}\lstinline@    return;@\\
\mbox{}\lstinline@  }@\\
\mbox{}\lstinline@}@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb5c}{5c}, \NWlink{nuweb6a}{6a}, \NWlink{nuweb7b}{7b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

Not necessary in use but handy for development.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap6}\raggedright\small
\NWtarget{nuweb6a}{}$\langle\,${\itshape functions}\nobreak\ {\footnotesize{6a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@void serialPrintReadings()@\\
\mbox{}\lstinline@{@\\
\mbox{}\lstinline@  Serial.print("Humidity: ");@\\
\mbox{}\lstinline@  Serial.print(humidity);@\\
\mbox{}\lstinline@  Serial.print(" % | ");@\\
\mbox{}\lstinline@  Serial.print("Temperature: ");@\\
\mbox{}\lstinline@  Serial.print(temperature);@\\
\mbox{}\lstinline@  Serial.println(" C");@\\
\mbox{}\lstinline@}@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb5c}{5c}, \NWlink{nuweb6a}{6a}, \NWlink{nuweb7b}{7b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Ethernet Client}

aWOT is in version 3

\verb|lasselukkari/aWOT@0.0.0-alpha+sha.bf07e6371c|


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap7}\raggedright\small
\NWtarget{nuweb6b}{}$\langle\,${\itshape libraries}\nobreak\ {\footnotesize{6b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@// Ethernet shield@\\
\mbox{}\lstinline@#include <Ethernet.h>@\\
\mbox{}\lstinline@#include <aWOT.h>@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb4b}{4b}, \NWlink{nuweb6b}{6b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap8}\raggedright\small
\NWtarget{nuweb6c}{}$\langle\,${\itshape configuration}\nobreak\ {\footnotesize{6c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@// Enter a MAC address and IP address for your controller below.@\\
\mbox{}\lstinline@// The IP address will be dependent on your local network:@\\
\mbox{}\lstinline@byte mac[] = {@\\
\mbox{}\lstinline@  0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED@\\
\mbox{}\lstinline@};@\\
\mbox{}\lstinline@IPAddress ip(10, 0, 21, 211);@\\
\mbox{}\lstinline@// Initialize the Ethernet server library@\\
\mbox{}\lstinline@// with the IP address and port you want to use@\\
\mbox{}\lstinline@// (port 80 is default for HTTP):@\\
\mbox{}\lstinline@EthernetServer server(80);@\\
\mbox{}\lstinline@Application app;@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb5a}{5a}, \NWlink{nuweb6c}{6c}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

No need to over do the rate besides it takes abot about 250 milliseconds to poll the sensor.
Prometheus normally scrapes every minute.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap9}\raggedright\small
\NWtarget{nuweb7a}{}$\langle\,${\itshape loop}\nobreak\ {\footnotesize{7a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@  // Wait a couple of seconds between measurements.@\\
\mbox{}\lstinline@  delay(2000);@\\
\mbox{}\lstinline@  // Reading temperature or humidity takes about 250 milliseconds@\\
\mbox{}\lstinline@  // Sensor readings may also be up to 2 seconds 'old'@\\
\mbox{}\lstinline@  readSensor();@\\
\mbox{}\lstinline@  serialPrintReadings();@\\
\mbox{}\lstinline@  EthernetClient client = server.available();@\\
\mbox{}\lstinline@  if (client.connected()) {@\\
\mbox{}\lstinline@    app.process(&client);@\\
\mbox{}\lstinline@    client.stop();@\\
\mbox{}\lstinline@  }@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

Prometheus style metrics for scraping.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap10}\raggedright\small
\NWtarget{nuweb7b}{}$\langle\,${\itshape functions}\nobreak\ {\footnotesize{7b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{\setlength{\leftmargin}{1em}} \item
\mbox{}\lstinline@void metricsCmd(Request &req, Response &res)@\\
\mbox{}\lstinline@{@\\
\mbox{}\lstinline@  Serial.println("Request for metrics");@\\
\mbox{}\lstinline@  res.set("Content-Type", "text/plain");@\\
\mbox{}\lstinline@  res.print("# HELP temperature is the last temperature reading in degrees celsius\n");@\\
\mbox{}\lstinline@  res.print("# TYPE temp gauge\n");@\\
\mbox{}\lstinline@  res.print("temperature " + String(temperature) + "\n");@\\
\mbox{}\lstinline@  res.print("# HELP humidity is the last relative humidity reading as a percentage\n");@\\
\mbox{}\lstinline@  res.print("# TYPE humidity gauge\n");@\\
\mbox{}\lstinline@  res.print("humidity " + String(humidity) + "\n");@\\
\mbox{}\lstinline@}@\\
\mbox{}{\NWsep}
\end{list}
\vspace{-1ex}
\vspace{-1ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb5c}{5c}, \NWlink{nuweb6a}{6a}, \NWlink{nuweb7b}{7b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb4a}{4a}.
\end{list}
\end{minipage}
\end{flushleft}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Upload}

Drivers on PC.

read back doesn't always work.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Testing}

\begin{verbatim}
  --- Quit: Ctrl+C | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---
  Webserver set up
  Sensor set up
  Humidity: 55.90 % | Temperature: 22.10 C
  Humidity: 56.30 % | Temperature: 22.20 C
\end{verbatim}


Rather than link up to a router

\begin{itemize}
  \item Assign a manual IP address to the laptop's ethernet connection say 10.0.21.1.
  \item Subnet mask 255.255.255.0.
  \item Assign a manual IP address to the Arduino's ethernet, say 10.0.21.211.
  \item Subnet mask 255.255.255.0.
  \item Leave the default Gateway empty.
  \item Use an ethernet patch cable to link the two (since 100BaseT onwards it doesn't have to be a special cross over cable).
  \item You should then be able to get your Arduino site up on \url{http://192.168.0.2} from the laptop.
\end{itemize}
  
This is the endpoint at \url{http://10.0.21.211/metrics}.
  
\begin{verbatim}
  > curl 10.0.21.211
  # HELP temperature is the last temperature reading in degrees celsius
  # TYPE temp gauge
  temperature 23.30
  # HELP humidity is the last relative humidity reading as a percentage
  # TYPE humidity gauge
  humidity 47.60
\end{verbatim}

\verb|docker-compose up|

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{graph.jpg}
  \caption{Temperature graph}
\end{figure}
  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Packaging}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{sensor-mount.jpg}
  \caption{Components for mounting the sensor}
\end{figure}

2.5 mm holes and 4 mm holes.

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{packaging.jpg}
  \caption{Mounted sensor and wiring}
\end{figure}

\end{document}